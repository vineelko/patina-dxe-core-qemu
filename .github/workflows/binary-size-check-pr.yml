# @file binary-size-check.yml
#
# GitHub Actions workflow to compare binary sizes for PRs.
#
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0

name: Binary Size Check PR

on:
  pull_request:

jobs:
  run:
    name: Binary Size Check PR
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, ubuntu-24.04-arm ]

    steps:
      - name: âœ… Checkout Base Branch (origin/${{ github.base_ref }}) âœ…
        uses: actions/checkout@v6
        with:
          ref: origin/${{ github.base_ref }}
          fetch-depth: 0  # ensure full history

      - name: ðŸ› ï¸ Download Rust Tools Base Branch (origin/${{ github.base_ref }}) ðŸ› ï¸
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Build Base Branch (origin/${{ github.base_ref }})
        run: |
          cargo make q35
          cargo make sbsa
          cargo make q35-release
          cargo make sbsa-release

      - name: Get Base Branch (origin/${{ github.base_ref }}) Sizes
        id: size-base
        shell: bash
        run: |
          get_size() { python3 -c "import os; print(os.path.getsize('$1'))"; }
          echo "x64_debug=$(get_size target/x86_64-unknown-uefi/debug/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "x64_release=$(get_size target/x86_64-unknown-uefi/release/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_debug=$(get_size target/aarch64-unknown-uefi/debug/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_release=$(get_size target/aarch64-unknown-uefi/release/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT

      - name: âœ… Checkout PR Branch (origin/${{ github.head_ref }}) âœ…
        uses: actions/checkout@v6
        with:
          ref: origin/${{ github.head_ref }}
          fetch-depth: 0

      - name: ðŸ› ï¸ Download Rust Tools PR Branch (origin/${{ github.head_ref }}) ðŸ› ï¸
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Build PR Branch (origin/${{ github.head_ref }})
        run: |
          cargo make q35
          cargo make sbsa
          cargo make q35-release
          cargo make sbsa-release

      - name: Get PR Branch (origin/${{ github.head_ref }}) Sizes
        id: size-pr
        shell: bash
        run: |
          get_size() { python3 -c "import os; print(os.path.getsize('$1'))"; }
          echo "x64_debug=$(get_size target/x86_64-unknown-uefi/debug/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "x64_release=$(get_size target/x86_64-unknown-uefi/release/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_debug=$(get_size target/aarch64-unknown-uefi/debug/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_release=$(get_size target/aarch64-unknown-uefi/release/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Binary Size Report - ${{ matrix.os }}
        shell: bash
        run: |
          pretty_size() {
            local bytes=$1
            local sign=""
            if (( bytes < 0 )); then sign="-"; bytes=$(( -bytes )); fi
            awk -v b="$bytes" -v s="$sign" 'BEGIN {
              if (b < 1024) { printf "%s%.2f B", s, b }
              else if (b < 1024*1024) { printf "%s%.2f KiB", s, b/1024 }
              else { printf "%s%.2f MiB", s, b/(1024*1024) }
            }'
          }

          SHA1="${{ github.base_ref }}"
          SHA2="${{ github.head_ref }}"

          X64_SHA1_DEBUG=${{ steps.size-base.outputs.x64_debug }}
          X64_SHA2_DEBUG=${{ steps.size-pr.outputs.x64_debug }}
          X64_DEBUG_DIFF=$((X64_SHA2_DEBUG - X64_SHA1_DEBUG))

          X64_SHA1_RELEASE=${{ steps.size-base.outputs.x64_release }}
          X64_SHA2_RELEASE=${{ steps.size-pr.outputs.x64_release }}
          X64_RELEASE_DIFF=$((X64_SHA2_RELEASE - X64_SHA1_RELEASE))

          AARCH64_SHA1_DEBUG=${{ steps.size-base.outputs.aarch64_debug }}
          AARCH64_SHA2_DEBUG=${{ steps.size-pr.outputs.aarch64_debug }}
          AARCH64_DEBUG_DIFF=$((AARCH64_SHA2_DEBUG - AARCH64_SHA1_DEBUG))

          AARCH64_SHA1_RELEASE=${{ steps.size-base.outputs.aarch64_release }}
          AARCH64_SHA2_RELEASE=${{ steps.size-pr.outputs.aarch64_release }}
          AARCH64_RELEASE_DIFF=$((AARCH64_SHA2_RELEASE - AARCH64_SHA1_RELEASE))

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Binary Size Report

          | Architecture | Commit | Debug Size | Release Size |
          |--------------|--------|------------|--------------|
          | x86_64       | \`${SHA1}\` | $(pretty_size $X64_SHA1_DEBUG) | $(pretty_size $X64_SHA1_RELEASE) |
          | x86_64       | \`${SHA2}\` | $(pretty_size $X64_SHA2_DEBUG) | $(pretty_size $X64_SHA2_RELEASE) |
          | aarch64      | \`${SHA1}\` | $(pretty_size $AARCH64_SHA1_DEBUG) | $(pretty_size $AARCH64_SHA1_RELEASE) |
          | aarch64      | \`${SHA2}\` | $(pretty_size $AARCH64_SHA2_DEBUG) | $(pretty_size $AARCH64_SHA2_RELEASE) |

          ### Size Difference

          | Architecture | Î” Debug | Î” Release |
          |--------------|---------|-----------|
          | x86_64       | $(pretty_size $X64_DEBUG_DIFF) | $(pretty_size $X64_RELEASE_DIFF) |
          | aarch64      | $(pretty_size $AARCH64_DEBUG_DIFF) | $(pretty_size $AARCH64_RELEASE_DIFF) |
          EOF

      - name: Post Binary Size Report as PR Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY=$(cat "$GITHUB_STEP_SUMMARY")

          # Post comment using GitHub CLI
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$COMMENT_BODY"
